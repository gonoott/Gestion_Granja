<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Título actualizado para reflejar que está en la Nube -->
    <title>Gestión de Granja Avícola (Nube)</title>
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <!-- Carga de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Estilos personalizados (sin cambios) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        /* Para la barra de scroll en la lista de registros */
        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }
        /* Estilos para el modal */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
            max-width: 500px;
        }
        /* Estilos para el botón de navegación activo */
        .nav-link-active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .nav-link {
            transition: all 0.2s;
        }
        .nav-link:hover {
            background-color: #eef2ff; /* indigo-50 */
            color: #4f46e5; /* indigo-600 */
        }
        
        /* Estilos para las tarjetas de configuración */
        .config-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .config-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .config-item:last-child {
            border-bottom: none;
        }
        .config-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Ocultar flechas en input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
    
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Contenedor principal -->
    <div class="flex flex-col md:flex-row min-h-screen">
        
        <!-- Barra de Navegación Lateral -->
        <nav class="bg-white shadow-lg md:w-64 flex-shrink-0">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-indigo-600">Gestión Avícola</h1>
            </div>
            <div class="px-3 py-2">
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg nav-link" data-tab="dashboard">
                    <i data-feather="grid"></i> Dashboard
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg nav-link" data-tab="records">
                    <i data-feather="edit"></i> Registros Diarios
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg nav-link" data-tab="lots">
                    <i data-feather="home"></i> Lotes / Corrales
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg nav-link" data-tab="sales">
                    <i data-feather="dollar-sign"></i> Ventas
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg nav-link" data-tab="reports">
                    <i data-feather="download"></i> Reportes
                </a>
                <a href="#" class="flex items-center gap-3 px-4 py-3 rounded-lg nav-link" data-tab="config">
                    <i data-feather="settings"></i> Configuración
                </a>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main class="flex-1 p-6 md:p-10">
            
            <!-- SECCIÓN: Dashboard -->
            <div id="dashboard-content" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                
                <!-- Métricas Clave -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Total de Gallinas</h3>
                        <p class="text-3xl font-bold" id="metric-total-hens">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Stock de Alimento (kg)</h3>
                        <p class="text-3xl font-bold" id="metric-food-stock">0 <span class="text-lg">kg</span></p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Días de Alimento Restantes</h3>
                        <p class="text-3xl font-bold" id="metric-food-days-left">0 <span class="text-lg">días</span></p>
                    </div>
                    <!-- MODIFICADO: Ahora es total del MES -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Huevos Cosechados (Mes)</h3>
                        <p class="text-3xl font-bold" id="metric-eggs-today">0</p>
                    </div>
                    <!-- MODIFICADO: Ahora es total del MES -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Ventas (Mes)</h3>
                        <p class="text-3xl font-bold" id="metric-sales-today">$0</p>
                    </div>
                    <!-- NUEVO: Stock de Huevos -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Huevos en Stock</h3>
                        <p class="text-3xl font-bold" id="metric-egg-stock">0</p>
                    </div>
                </div>
                
                <!-- MODIFICADO: Ahora es Balance del MES -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Balance (Mes Actual)</h3>
                        <p class="text-3xl font-bold" id="metric-balance-month">$0</p>
                        <p class="text-sm text-gray-500" id="metric-balance-month-detail">(Ingresos: $0 - Gastos: $0)</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-sm font-medium text-gray-500">Balance Económico (Total)</h3>
                        <p class="text-3xl font-bold" id="metric-balance-total">$0</p>
                        <p class="text-sm text-gray-500" id="metric-balance-detail">(Ingresos: $0 - Gastos: $0)</p>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Producción de Huevos (por Mes)</h3>
                        <canvas id="eggProductionChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Ventas por Cliente</h3>
                        <canvas id="salesByClientChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: Registros Diarios -->
            <div id="records-content" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">Registros Diarios</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Columna de Formularios -->
                    <div>
                        <!-- Formulario de Registro Diario -->
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 class="text-xl font-semibold mb-4">Cargar Registro del Día</h3>
                            <form id="daily-record-form" class="space-y-4">
                                <div>
                                    <label for="record-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                    <input type="date" id="record-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="record-eggs" class="block text-sm font-medium text-gray-700">Huevos Cosechados</label>
                                    <input type="number" id="record-eggs" placeholder="Ej: 120" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="record-food" class="block text-sm font-medium text-gray-700">Alimento Suministrado (kg)</label>
                                    <input type="number" step="0.01" id="record-food" placeholder="Ej: 15.5" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <!-- NUEVO: Desplegable de Docentes -->
                                    <label for="record-responsible" class="block text-sm font-medium text-gray-700">Docente / Responsable</label>
                                    <select id="record-responsible" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                        <option value="">Seleccione un docente</option>
                                        <!-- Opciones se cargarán desde JS -->
                                    </select>
                                </div>
                                
                                <!-- NUEVO: Checkboxes de Actividades -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Actividades Realizadas</label>
                                    <div id="record-activities-checkboxes" class="mt-2 space-y-2 max-h-40 overflow-y-auto border p-3 rounded-md">
                                        <!-- Checkboxes se cargarán desde JS -->
                                        <p class="text-gray-500 text-sm">Cargue actividades en Configuración.</p>
                                    </div>
                                </div>
                                
                                <!-- NUEVO: Campo Observaciones -->
                                <div>
                                    <label for="record-observations" class="block text-sm font-medium text-gray-700">Observaciones</label>
                                    <textarea id="record-observations" rows="3" placeholder="Ej: Se observó un animal enfermo..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-700 transition">Guardar Registro</button>
                            </form>
                        </div>
                        
                        <!-- Formulario de Compra de Alimento -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Comprar Insumo (Alimento)</h3>
                            <form id="buy-food-form" class="space-y-4">
                                <div>
                                    <label for="buy-date" class="block text-sm font-medium text-gray-700">Fecha de Compra</label>
                                    <input type="date" id="buy-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <!-- NUEVO: Tipo de Alimento -->
                                <div>
                                    <label for="buy-type" class="block text-sm font-medium text-gray-700">Tipo de Insumo</label>
                                    <input type="text" id="buy-type" placeholder="Ej: Ponedora Fase 1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="buy-amount" class="block text-sm font-medium text-gray-700">Cantidad (kg)</label>
                                    <input type="number" step="0.01" id="buy-amount" placeholder="Ej: 500" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="buy-price" class="block text-sm font-medium text-gray-700">Precio Total ($)</label>
                                    <input type="number" step="0.01" id="buy-price" placeholder="Ej: 25000" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition">Añadir al Stock</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Columna de Listas -->
                    <div>
                        <!-- Lista de Registros Recientes -->
                        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                            <h3 class="text-xl font-semibold mb-4">Registros Recientes</h3>
                            <div id="daily-records-list" class="space-y-3 record-list pr-2">
                                <!-- Los registros se cargarán aquí -->
                            </div>
                        </div>
                        
                        <!-- Lista de Compras Recientes -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Compras Recientes de Insumos</h3>
                            <div id="food-purchases-list" class="space-y-3 record-list pr-2">
                                <!-- Las compras se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN: Lotes / Corrales -->
            <div id="lots-content" class="tab-content" style="display: none;">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Lotes / Corrales</h2>
                    <button id="add-lot-button" class="bg-indigo-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center gap-2">
                        <i data-feather="plus" class="w-5 h-5"></i> Añadir Lote
                    </button>
                </div>
                
                <div id="hen-lots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Las tarjetas de lotes se cargarán aquí -->
                </div>
            </div>

            <!-- SECCIÓN: Ventas -->
            <div id="sales-content" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">Gestión de Ventas</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Formulario de Venta -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Registrar Venta</h3>
                        <form id="sales-form" class="space-y-4">
                            <div>
                                <label for="sale-date" class="block text-sm font-medium text-gray-700">Fecha</label>
                                <input type="date" id="sale-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="sale-quantity" class="block text-sm font-medium text-gray-700">Cantidad de Huevos</label>
                                <input type="number" id="sale-quantity" placeholder="Ej: 30 (1 maple)" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="sale-price" class="block text-sm font-medium text-gray-700">Precio Total ($)</label>
                                <input type="number" step="0.01" id="sale-price" placeholder="Ej: 1500" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <!-- NUEVO: Desplegable de Clientes -->
                                <label for="sale-client" class="block text-sm font-medium text-gray-700">Cliente</o>
                                <select id="sale-client" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                    <option value="">Seleccione un cliente</option>
                                    <!-- Opciones se cargarán desde JS -->
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition">Guardar Venta</button>
                        </form>
                    </div>
                    
                    <!-- Lista de Ventas Recientes -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">Ventas Recientes</h3>
                        <div id="sales-list" class="space-y-3 record-list pr-2">
                            <!-- Las ventas se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SECCIÓN: Reportes -->
            <div id="reports-content" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">Generar Reportes</h2>
                <div class="bg-white p-6 rounded-lg shadow-md max-w-lg">
                    <div class="space-y-4">
                        <div class="flex items-end gap-4">
                            <!-- Selector de Año -->
                            <div class="flex-1">
                                <label for="report-year" class="block text-sm font-medium text-gray-700">Año</label>
                                <select id="report-year" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                    <!-- Se llena con JS -->
                                </select>
                            </div>
                            
                            <!-- NUEVO: Selector de Periodo -->
                            <div class="flex-1">
                                <label for="report-period" class="block text-sm font-medium text-gray-700">Periodo</label>
                                <select id="report-period" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                    <option value="monthly">Mensual</option>
                                    <option value="annual">Anual</option>
                                </select>
                            </div>
                            
                            <!-- Selector de Mes (se oculta si es anual) -->
                            <div id="report-month-container" class="flex-1">
                                <label for="report-month" class="block text-sm font-medium text-gray-700">Mes</label>
                                <select id="report-month" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                    <option value="0">Enero</option>
                                    <option value="1">Febrero</option>
                                    <option value="2">Marzo</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Mayo</option>
                                    <option value="5">Junio</option>
                                    <option value="6">Julio</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Septiembre</option>
                                    <option value="9">Octubre</option>
                                    <option value="10">Noviembre</option>
                                    <option value="11">Diciembre</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- NUEVO: Botón Unificado -->
                        <button id="download-unified-report" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                            <i data-feather="download"></i> Descargar Reporte Unificado (.csv)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- SECCIÓN: Configuración -->
            <div id="config-content" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">Configuración</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Gestionar Docentes -->
                    <div class="config-card">
                        <h3>Gestionar Docentes</h3>
                        <form id="config-teacher-form" class="flex gap-2 mb-4">
                            <input type="text" id="config-teacher-name" placeholder="Nombre del docente" required class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="submit" class="bg-indigo-600 text-white px-3 py-2 rounded-md hover:bg-indigo-700 transition">
                                <i data-feather="plus"></i>
                            </button>
                        </form>
                        <div id="config-teacher-list" class="config-list">
                            <!-- Lista de docentes -->
                        </div>
                    </div>
                    
                    <!-- Gestionar Clientes -->
                    <div class="config-card">
                        <h3>Gestionar Clientes</h3>
                        <form id="config-client-form" class="flex gap-2 mb-4">
                            <input type="text" id="config-client-name" placeholder="Nombre del cliente" required class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="submit" class="bg-indigo-600 text-white px-3 py-2 rounded-md hover:bg-indigo-700 transition">
                                <i data-feather="plus"></i>
                            </button>
                        </form>
                        <div id="config-client-list" class="config-list">
                            <!-- Lista de clientes -->
                        </div>
                    </div>
                    
                    <!-- NUEVO: Gestionar Actividades -->
                    <div class="config-card">
                        <h3>Gestionar Actividades</h3>
                        <form id="config-activity-form" class="flex gap-2 mb-4">
                            <input type="text" id="config-activity-name" placeholder="Ej: Limpieza" required class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="submit" class="bg-indigo-600 text-white px-3 py-2 rounded-md hover:bg-indigo-700 transition">
                                <i data-feather="plus"></i>
                            </button>
                        </form>
                        <div id="config-activity-list" class="config-list">
                            <!-- Lista de actividades -->
                        </div>
                    </div>
                </div>
                
                <!-- Zona de Peligro -->
                <div class="mt-10 pt-6 border-t border-red-300 max-w-lg">
                    <h3 class="text-xl font-semibold text-red-700 mb-4">Zona de Peligro</h3>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-sm text-red-800 mb-4">
                            Esto borrará permanentemente todos los lotes, registros, ventas, insumos y configuraciones de la base de datos.
                        </p>
                        <button id="reset-all-data-button" class="w-full bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition">
                            Borrar Todos los Datos de Prueba
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Pie de página con ID de Usuario -->
    <footer class="bg-gray-800 text-gray-400 text-xs p-2 text-center fixed bottom-0 w-full">
        Conectado como: <span id="user-id-display" class="font-mono">Cargando...</span>
    </footer>


    <!-- Modal Genérico (para Lotes) -->
    <div id="lot-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Añadir Lote</h2>
            <form id="lot-form">
                <input type="hidden" id="lot-id">
                <div class="space-y-4">
                    <div>
                        <label for="lot-name" class="block text-sm font-medium text-gray-700">Nombre del Lote</label>
                        <input type="text" id="lot-name" placeholder="Ej: Corral A-1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="lot-hens" class="block text-sm font-medium text-gray-700">Cantidad de Gallinas</label>
                        <input type="number" id="lot-hens" placeholder="Ej: 100" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="lot-roosters" class="block text-sm font-medium text-gray-700">Cantidad de Gallos</label>
                        <input type="number" id="lot-roosters" placeholder="Ej: 10" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <!-- MODIFICADO: Ración por animal -->
                        <label for="lot-ration" class="block text-sm font-medium text-gray-700">Ración por Animal (kg)</label>
                        <input type="number" step="0.001" id="lot-ration" placeholder="Ej: 0.120" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="lot-age" class="block text-sm font-medium text-gray-700">Edad (semanas)</label>
                        <input type="number" id="lot-age" placeholder="Ej: 25" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="lot-date" class="block text-sm font-medium text-gray-700">Fecha de Ingreso</label>
                        <input type="date" id="lot-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-lot-button" class="bg-white text-gray-700 px-4 py-2 rounded-md border border-gray-300 hover:bg-gray-50">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-indigo-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmación de Borrado -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform scale-95">
            <h2 id="confirm-modal-title" class="text-xl font-bold mb-4">¿Estás seguro?</h2>
            <p id="confirm-modal-text" class="text-gray-700 mb-6">Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="confirm-cancel-button" class="bg-white text-gray-700 px-4 py-2 rounded-md border border-gray-300 hover:bg-gray-50">Cancelar</button>
                <button type="button" id="confirm-delete-button" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700">Confirmar Borrado</button>
            </div>
        </div>
    </div>
    
    <!-- Toast de Notificación -->
    <div id="toast" class="fixed bottom-10 right-10 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-xl opacity-0 translate-y-10 transition-all duration-300">
        <span id="toast-message"></span>
    </div>


    <!-- Scripts de la Aplicación (Firebase) -->
    <script type="module">
        
        // --- 0. IMPORTACIONES DE FIREBASE ---
        // Importar funciones necesarias
        // ACTUALIZADO: Versiones de SDK a 9.23.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            writeBatch,
            getDocs,
            Timestamp,
            increment,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        
        // --- 1. CONFIGURACIÓN DE FIREBASE ---
        // Esta es la configuración que nos pasaste.
        // La he limpiado para usar solo lo necesario para Firestore y Auth.
        const firebaseConfig = {
          apiKey: "AIzaSyDMjancMAkR86g1wz2RtIupUjiZkiGRQjE",
          authDomain: "gestion-avicola-7b57b.firebaseapp.com",
          projectId: "gestion-avicola-7b57b",
          // CORREGIDO: "appspot.com" es la URL correcta para el storage bucket
          storageBucket: "gestion-avicola-7b57b.appspot.com", 
          messagingSenderId: "596600543351",
          appId: "1:596600543351:web:4bc1af8bc6e4ad5806ce72"
          // measurementId (Analytics) fue removido ya que no se usa y puede dar errores.
        };

        
        // --- 2. INICIALIZACIÓN DE SERVICIOS ---
        
        // Variables globales de la App
        let app, auth, db;
        let userId = null; // ID del usuario anónimo
        
        // Almacenes locales de datos (caché)
        let allHenLots = [];
        let allDailyRecords = [];
        let allPurchases = [];
        let allSales = [];
        let allTeachers = [];
        let allClients = [];
        let allActivities = [];

        // Gráficos
        let eggChart = null;
        let salesChart = null;
        
        // Referencias a elementos del DOM
        const tabs = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // Modal de Lotes
        const addLotButton = document.getElementById('add-lot-button');
        const lotModal = document.getElementById('lot-modal');
        const cancelLotButton = document.getElementById('cancel-lot-button');
        const lotForm = document.getElementById('lot-form');
        const modalTitle = document.getElementById('modal-title');
        const lotIdInput = document.getElementById('lot-id');
        
        // Modal de Confirmación
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelButton = document.getElementById('confirm-cancel-button');
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        let deleteConfirmCallback = null; // Función a ejecutar al confirmar

        // Toast de Notificación
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        // Formularios
        const dailyRecordForm = document.getElementById('daily-record-form');
        const buyFoodForm = document.getElementById('buy-food-form');
        const salesForm = document.getElementById('sales-form');
        
        // Configuración
        const configTeacherForm = document.getElementById('config-teacher-form');
        const configClientForm = document.getElementById('config-client-form');
        const configActivityForm = document.getElementById('config-activity-form');
        const resetAllDataButton = document.getElementById('reset-all-data-button');
        
        // Reportes
        const reportYearSelect = document.getElementById('report-year');
        const reportMonthSelect = document.getElementById('report-month');
        const reportPeriodSelect = document.getElementById('report-period');
        const reportMonthContainer = document.getElementById('report-month-container');
        const downloadUnifiedReportButton = document.getElementById('download-unified-report');

        
        // --- 3. FUNCIONES DE INICIALIZACIÓN ---

        // Función principal que se ejecuta al cargar la página
        async function initializeAppAndAuth() {
            try {
                // Inicializar Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Escuchar cambios de autenticación
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // El usuario ya está logueado
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        // Iniciar la carga de datos
                        setupAllListeners();
                    } else {
                        // No hay usuario, intentar login anónimo
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Error crítico al inicializar Firebase:", error);
                showToast("Error crítico al conectar. Verifique la config.", "error");
            }
            
            setupUIListeners();
            feather.replace(); // Activar iconos
            setInitialTab('dashboard');
            
            // Inicializar selectores de reportes
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 5; i--) {
                reportYearSelect.innerHTML += `<option value="${i}">${i}</option>`;
            }
            reportMonthSelect.value = new Date().getMonth().toString();
        }

        // Configura todos los listeners de la base de datos
        function setupAllListeners() {
            if (!userId) return;

            // Paths de colecciones
            const collectionsPaths = {
                'hen_lots': (data) => { allHenLots = data; renderHenLots(); updateDashboard(); },
                'daily_records': (data) => { allDailyRecords = data; renderDailyRecords(); updateDashboard(); updateCharts(); },
                'purchases': (data) => { allPurchases = data; renderPurchases(); updateDashboard(); },
                'sales': (data) => { allSales = data; renderSales(); updateDashboard(); updateCharts(); },
                'config_teachers': (data) => { allTeachers = data; renderConfigList(data, 'config-teacher-list', deleteConfigItem); updateTeacherDropdowns(); },
                'config_clients': (data) => { allClients = data; renderConfigList(data, 'config-client-list', deleteConfigItem); updateClientDropdowns(); },
                'config_activities': (data) => { allActivities = data; renderConfigList(data, 'config-activity-list', deleteConfigItem); updateActivityCheckboxes(); },
            };
            
            // Crear un listener por cada colección
            for (const [path, callback] of Object.entries(collectionsPaths)) {
                const collectionRef = collection(db, `users/${userId}/${path}`);
                onSnapshot(collectionRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    callback(data);
                }, (error) => {
                    console.error(`Error escuchando ${path}:`, error);
                    showToast(`Error cargando ${path}`, "error");
                });
            }
        }
        
        // Configura los listeners de la UI (botones, formularios, etc.)
        function setupUIListeners() {
            // Navegación de Pestañas
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = tab.getAttribute('data-tab');
                    setInitialTab(tabName);
                });
            });

            // Modal de Lotes
            addLotButton.addEventListener('click', showLotModal);
            cancelLotButton.addEventListener('click', hideLotModal);
            lotForm.addEventListener('submit', handleLotFormSubmit);
            
            // Modal de Confirmación
            confirmCancelButton.addEventListener('click', hideConfirmModal);
            confirmDeleteButton.addEventListener('click', () => {
                if (deleteConfirmCallback) {
                    deleteConfirmCallback();
                }
                hideConfirmModal();
            });
            
            // Formularios de Registros
            dailyRecordForm.addEventListener('submit', handleDailyRecordSubmit);
            buyFoodForm.addEventListener('submit', handleBuyFoodSubmit);
            
            // Formulario de Ventas
            salesForm.addEventListener('submit', handleSalesFormSubmit);
            
            // Formularios de Configuración
            configTeacherForm.addEventListener('submit', handleConfigFormSubmit('config_teachers', 'config-teacher-name'));
            configClientForm.addEventListener('submit', handleConfigFormSubmit('config_clients', 'config-client-name'));
            configActivityForm.addEventListener('submit', handleConfigFormSubmit('config_activities', 'config-activity-name'));
            resetAllDataButton.addEventListener('click', handleResetAllData);
            
            // Reportes
            downloadUnifiedReportButton.addEventListener('click', generateUnifiedReport);
            reportPeriodSelect.addEventListener('change', () => {
                reportMonthContainer.style.display = reportPeriodSelect.value === 'annual' ? 'none' : 'block';
            });
        }


        // --- 4. LÓGICA DE NAVEGACIÓN Y UI ---

        // Muestra una pestaña y oculta las demás
        function setInitialTab(tabName) {
            tabContents.forEach(content => {
                content.style.display = content.id === `${tabName}-content` ? 'block' : 'none';
            });
            tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('nav-link-active');
                } else {
                    tab.classList.remove('nav-link-active');
                }
            });
            
            // Recargar gráficos si se va al dashboard
            if (tabName === 'dashboard') {
                updateCharts();
            }
        }
        
        // Muestra una notificación (toast)
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-10');
            toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-gray-900');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
                if(type === 'error') {
                    toast.classList.remove('bg-red-600');
                } else {
                    toast.classList.remove('bg-gray-900');
                }
            }, 3000);
        }

        // Muestra el modal de lotes (para añadir o editar)
        function showLotModal(event, lot = null) {
            if (lot) {
                // Editar Lote
                modalTitle.textContent = 'Editar Lote';
                lotIdInput.value = lot.id;
                document.getElementById('lot-name').value = lot.name;
                document.getElementById('lot-hens').value = lot.henCount;
                document.getElementById('lot-roosters').value = lot.roosterCount;
                document.getElementById('lot-ration').value = lot.rationPerAnimalKg;
                document.getElementById('lot-age').value = lot.ageWeeks;
                // Corregir formato de fecha para input tipo 'date' (YYYY-MM-DD)
                const dateStr = lot.dateAdded.toDate ? lot.dateAdded.toDate().toISOString().split('T')[0] : lot.dateAdded.split('T')[0];
                document.getElementById('lot-date').value = dateStr;
            } else {
                // Añadir Lote
                modalTitle.textContent = 'Añadir Lote';
                lotForm.reset();
                lotIdInput.value = '';
            }
            lotModal.classList.remove('opacity-0', 'pointer-events-none');
            lotModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        // Oculta el modal de lotes
        function hideLotModal() {
            lotModal.classList.add('opacity-0', 'pointer-events-none');
            lotModal.querySelector('.modal-content').classList.add('scale-95');
        }
        
        // Muestra el modal de confirmación
        function showConfirmModal(title, text, onConfirm) {
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = text;
            deleteConfirmCallback = onConfirm; // Asignar la función a ejecutar
            
            confirmModal.classList.remove('opacity-0', 'pointer-events-none');
            confirmModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        // Oculta el modal de confirmación
        function hideConfirmModal() {
            confirmModal.classList.add('opacity-0', 'pointer-events-none');
            confirmModal.querySelector('.modal-content').classList.add('scale-95');
            deleteConfirmCallback = null;
        }


        // --- 5. LÓGICA DE DATOS (Firebase) ---
        
        // Guardar (añadir o editar) un Lote
        async function handleLotFormSubmit(e) {
            e.preventDefault();
            if (!userId) return;

            const id = lotIdInput.value;
            const lotData = {
                name: document.getElementById('lot-name').value,
                henCount: parseInt(document.getElementById('lot-hens').value),
                roosterCount: parseInt(document.getElementById('lot-roosters').value),
                rationPerAnimalKg: parseFloat(document.getElementById('lot-ration').value),
                ageWeeks: parseInt(document.getElementById('lot-age').value),
                dateAdded: Timestamp.fromDate(new Date(document.getElementById('lot-date').value + 'T00:00:00')) // Asegurar fecha correcta
            };

            try {
                let docRef;
                if (id) {
                    // Editar
                    docRef = doc(db, `users/${userId}/hen_lots`, id);
                    await setDoc(docRef, lotData);
                    showToast('Lote actualizado exitosamente.');
                } else {
                    // Añadir
                    docRef = collection(db, `users/${userId}/hen_lots`);
                    await addDoc(docRef, lotData);
                    showToast('Lote guardado exitosamente.');
                }
                hideLotModal();
                lotForm.reset();
            } catch (error) {
                console.error('Error al guardar lote:', error);
                showToast('Error al guardar lote. Verifique las reglas.', 'error');
            }
        }
        
        // Borrar un Lote
        async function deleteLot(id) {
            if (!userId) return;
            
            showConfirmModal('Borrar Lote', '¿Estás seguro de que quieres borrar este lote? Esta acción es permanente.', async () => {
                try {
                    const docRef = doc(db, `users/${userId}/hen_lots`, id);
                    await deleteDoc(docRef);
                    showToast('Lote borrado.');
                } catch (error) {
                    console.error('Error al borrar lote:', error);
                    showToast('Error al borrar lote.', 'error');
                }
            });
        }
        
        // Guardar Registro Diario
        async function handleDailyRecordSubmit(e) {
            e.preventDefault();
            if (!userId) return;
            
            const foodAmount = parseFloat(document.getElementById('record-food').value);
            
            // Validar stock
            const stock = await getInventoryStock();
            if (foodAmount > stock) {
                showToast(`Error: No hay suficiente alimento. Stock: ${stock} kg.`, 'error');
                return;
            }
            
            // Obtener actividades seleccionadas
            const selectedActivities = [];
            document.querySelectorAll('#record-activities-checkboxes input:checked').forEach(input => {
                selectedActivities.push(input.value);
            });
            
            const recordData = {
                date: Timestamp.fromDate(new Date(document.getElementById('record-date').value + 'T00:00:00')),
                eggsHarvested: parseInt(document.getElementById('record-eggs').value),
                foodSuppliedKg: foodAmount,
                responsible: document.getElementById('record-responsible').value,
                activities: selectedActivities, // NUEVO
                observations: document.getElementById('record-observations').value, // NUEVO
                createdAt: Timestamp.now()
            };
            
            try {
                // 1. Guardar el registro
                const docRef = collection(db, `users/${userId}/daily_records`);
                await addDoc(docRef, recordData);
                
                // 2. Descontar del inventario
                await updateInventoryStock(-foodAmount); // Restar del stock
                
                showToast('Registro diario guardado.');
                dailyRecordForm.reset();
                // Limpiar checkboxes manualmente
                document.querySelectorAll('#record-activities-checkboxes input:checked').forEach(input => {
                    input.checked = false;
                });
            } catch (error) {
                console.error('Error al guardar registro:', error);
                showToast('Error al guardar registro.', 'error');
            }
        }
        
        // Borrar Registro Diario
        async function deleteDailyRecord(id, foodSuppliedKg) {
            if (!userId) return;
            
            showConfirmModal('Borrar Registro', '¿Seguro? Esto devolverá el alimento suministrado al stock.', async () => {
                try {
                    // 1. Borrar el registro
                    const docRef = doc(db, `users/${userId}/daily_records`, id);
                    await deleteDoc(docRef);
                    
                    // 2. Devolver el alimento al stock
                    await updateInventoryStock(foodSuppliedKg);
                    
                    showToast('Registro borrado.');
                } catch (error) {
                    console.error('Error al borrar registro:', error);
                    showToast('Error al borrar registro.', 'error');
                }
            });
        }
        
        // Comprar Alimento (Insumo)
        async function handleBuyFoodSubmit(e) {
            e.preventDefault();
            if (!userId) return;

            const foodAmount = parseFloat(document.getElementById('buy-amount').value);
            const purchaseData = {
                date: Timestamp.fromDate(new Date(document.getElementById('buy-date').value + 'T00:00:00')),
                type: document.getElementById('buy-type').value,
                amountKg: foodAmount,
                price: parseFloat(document.getElementById('buy-price').value),
                createdAt: Timestamp.now()
            };
            
            try {
                // 1. Guardar la compra
                const docRef = collection(db, `users/${userId}/purchases`);
                await addDoc(docRef, purchaseData);
                
                // 2. Añadir al inventario
                await updateInventoryStock(foodAmount); // Sumar al stock
                
                showToast('Compra registrada. Stock actualizado.');
                buyFoodForm.reset();
            } catch (error) {
                console.error('Error al registrar compra:', error);
                showToast('Error al registrar compra.', 'error');
            }
        }
        
        // Borrar Compra de Insumo
        async function deletePurchase(id, amountKg) {
            if (!userId) return;
            
            const stock = await getInventoryStock();
            if (amountKg > stock) {
                showToast(`Error: No se puede borrar. El stock (${stock} kg) quedaría negativo.`, 'error');
                return;
            }
            
            showConfirmModal('Borrar Compra', '¿Seguro? Esto descontará el insumo del stock.', async () => {
                try {
                    // 1. Borrar la compra
                    const docRef = doc(db, `users/${userId}/purchases`, id);
                    await deleteDoc(docRef);
                    
                    // 2. Descontar del stock
                    await updateInventoryStock(-amountKg);
                    
                    showToast('Compra borrada.');
                } catch (error) {
                    console.error('Error al borrar compra:', error);
                    showToast('Error al borrar compra.', 'error');
                }
            });
        }
        
        // Registrar Venta
        async function handleSalesFormSubmit(e) {
            e.preventDefault();
            if (!userId) return;
            
            // Validar stock de huevos
            const eggsSold = parseInt(document.getElementById('sale-quantity').value);
            const { totalHarvested, totalSold } = calculateEggTotals();
            const eggStock = totalHarvested - totalSold;
            
            if (eggsSold > eggStock) {
                showToast(`Error: No hay suficientes huevos. Stock: ${eggStock}`, 'error');
                return;
            }

            const saleData = {
                date: Timestamp.fromDate(new Date(document.getElementById('sale-date').value + 'T00:00:00')),
                quantity: eggsSold,
                price: parseFloat(document.getElementById('sale-price').value),
                client: document.getElementById('sale-client').value,
                createdAt: Timestamp.now()
            };
            
            try {
                const docRef = collection(db, `users/${userId}/sales`);
                await addDoc(docRef, saleData);
                showToast('Venta registrada.');
                salesForm.reset();
            } catch (error) {
                console.error('Error al registrar venta:', error);
                showToast('Error al registrar venta.', 'error');
            }
        }
        
        // Borrar Venta
        async function deleteSale(id) {
            if (!userId) return;
            
            showConfirmModal('Borrar Venta', '¿Seguro? Esto devolverá los huevos al stock.', async () => {
                try {
                    const docRef = doc(db, `users/${userId}/sales`, id);
                    await deleteDoc(docRef);
                    showToast('Venta borrada.');
                } catch (error) {
                    console.error('Error al borrar venta:', error);
                    showToast('Error al borrar venta.', 'error');
                }
            });
        }
        
        // ---- Lógica de Inventario (Singleton) ----
        
        // Obtener el stock actual (solo lectura)
        async function getInventoryStock() {
            if (!userId) return 0;
            const docRef = doc(db, `users/${userId}/inventory/main`);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().foodStockKg || 0;
                }
                return 0;
            } catch (e) {
                return 0;
            }
        }
        
        // Actualizar el stock (sumar o restar)
        async function updateInventoryStock(amount) {
            if (!userId) return;
            const docRef = doc(db, `users/${userId}/inventory/main`);
            try {
                // Usamos 'increment' para evitar problemas de concurrencia
                // y 'setDoc' con 'merge: true' para crear el doc si no existe.
                await setDoc(docRef, { 
                    foodStockKg: increment(amount) 
                }, { merge: true });
            } catch (error) {
                console.error("Error actualizando stock:", error);
                showToast("Error crítico al actualizar stock.", "error");
            }
        }
        
        // ---- Lógica de Configuración ----
        
        // Handler genérico para forms de Configuración
        function handleConfigFormSubmit(collectionName, inputId) {
            return async (e) => {
                e.preventDefault();
                if (!userId) return;
                
                const input = document.getElementById(inputId);
                const name = input.value.trim();
                if (!name) return;
                
                try {
                    const colRef = collection(db, `users/${userId}/${collectionName}`);
                    await addDoc(colRef, { name, createdAt: Timestamp.now() });
                    input.value = '';
                } catch (error) {
                    console.error(`Error guardando ${collectionName}:`, error);
                    showToast('Error al guardar.', 'error');
                }
            };
        }
        
        // Borrar item de Configuración
        async function deleteConfigItem(collectionName, id) {
            if (!userId) return;
            // No se pide confirmación para items de config por ser de bajo riesgo
            try {
                const docRef = doc(db, `users/${userId}/${collectionName}`, id);
                await deleteDoc(docRef);
            } catch (error) {
                console.error(`Error borrando ${collectionName}:`, error);
                showToast('Error al borrar.', 'error');
            }
        }
        
        // Resetear todos los datos
        async function handleResetAllData() {
            if (!userId) return;
            
            showConfirmModal('BORRAR TODO', 'Estás a punto de borrar TODOS los datos. Escribe "BORRAR" para confirmar.', async () => {
                const confirmation = prompt('Para confirmar, escribe "BORRAR" (en mayúsculas):');
                if (confirmation !== 'BORRAR') {
                    showToast('Borrado cancelado.', 'error');
                    return;
                }

                showToast('Borrando todos los datos...', 'success');
                try {
                    const collections = [
                        'hen_lots', 'daily_records', 'purchases', 'sales',
                        'config_teachers', 'config_clients', 'config_activities'
                    ];
                    
                    const batch = writeBatch(db);

                    // Borrar todas las colecciones
                    for (const col of collections) {
                        const colRef = collection(db, `users/${userId}/${col}`);
                        const snapshot = await getDocs(colRef);
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                    }
                    
                    // Borrar el inventario (documento suelto)
                    const invRef = doc(db, `users/${userId}/inventory/main`);
                    batch.delete(invRef);
                    
                    await batch.commit();
                    showToast('Todos los datos han sido borrados.', 'success');
                } catch (error) {
                    console.error('Error al resetear datos:', error);
                    showToast('Error al borrar los datos.', 'error');
                }
            });
        }


        // --- 6. LÓGICA DE RENDERIZADO (UI) ---

        // Renderizar Lotes
        function renderHenLots() {
            const container = document.getElementById('hen-lots-container');
            container.innerHTML = ''; // Limpiar
            
            if (allHenLots.length === 0) {
                container.innerHTML = `<p class="text-gray-500 col-span-full">No hay lotes registrados. Añade uno para empezar.</p>`;
                return;
            }
            
            allHenLots.sort((a, b) => a.name.localeCompare(b.name));
            
            allHenLots.forEach(lot => {
                const date = lot.dateAdded.toDate ? lot.dateAdded.toDate() : new Date(lot.dateAdded);
                const totalAnimals = lot.henCount + lot.roosterCount;
                const lotCard = `
                    <div class="bg-white p-5 rounded-lg shadow-md">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-indigo-600">${lot.name}</h3>
                            <div class="flex gap-2">
                                <button class="edit-lot-btn text-gray-400 hover:text-blue-600" data-id="${lot.id}">
                                    <i data-feather="edit-2" class="w-5 h-5"></i>
                                </button>
                                <button class="delete-lot-btn text-gray-400 hover:text-red-600" data-id="${lot.id}">
                                    <i data-feather="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-1 text-sm text-gray-700">
                            <p><strong>Gallinas:</strong> ${lot.henCount}</p>
                            <p><strong>Gallos:</strong> ${lot.roosterCount}</p>
                            <p><strong>Total:</strong> ${totalAnimals} animales</p>
                            <p><strong>Ración/Animal:</strong> ${lot.rationPerAnimalKg} kg</p>
                            <p><strong>Ración Total Lote:</strong> ${(totalAnimals * lot.rationPerAnimalKg).toFixed(2)} kg/día</p>
                            <p><strong>Edad:</strong> ${lot.ageWeeks} semanas</p>
                            <p><strong>Ingreso:</strong> ${date.toLocaleDateString()}</p>
                        </div>
                    </div>
                `;
                container.innerHTML += lotCard;
            });
            
            // Activar iconos
            feather.replace();
            
            // Añadir listeners a los botones
            container.querySelectorAll('.edit-lot-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const lot = allHenLots.find(l => l.id === id);
                    showLotModal(e, lot);
                });
            });
            container.querySelectorAll('.delete-lot-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    deleteLot(id);
                });
            });
        }
        
        // Renderizar Registros Diarios
        function renderDailyRecords() {
            const list = document.getElementById('daily-records-list');
            list.innerHTML = '';
            
            if (allDailyRecords.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-sm">No hay registros diarios.</p>`;
                return;
            }
            
            // Ordenar por fecha (más nuevos primero)
            allDailyRecords.sort((a, b) => b.date.seconds - a.date.seconds);
            
            allDailyRecords.forEach(record => {
                const date = record.date.toDate();
                // NUEVO: Mostrar actividades y observaciones
                const activitiesText = record.activities && record.activities.length > 0
                    ? record.activities.join(', ')
                    : 'N/A';
                const observationsText = record.observations ? record.observations : 'Sin observaciones.';
                
                const item = `
                    <div class="p-3 bg-gray-50 rounded-md border">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-indigo-600">${date.toLocaleDateString()}</span>
                            <button class="delete-record-btn text-gray-400 hover:text-red-600" data-id="${record.id}" data-food="${record.foodSuppliedKg}">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-sm"><strong>Huevos:</strong> ${record.eggsHarvested}</p>
                        <p class="text-sm"><strong>Alimento:</strong> ${record.foodSuppliedKg} kg</p>
                        <p class="text-sm"><strong>Responsable:</strong> ${record.responsible}</p>
                        <p class="text-sm"><strong>Actividades:</strong> ${activitiesText}</p>
                        <p class="text-sm text-gray-500 italic mt-1">"${observationsText}"</p>
                    </div>
                `;
                list.innerHTML += item;
            });
            
            feather.replace();
            
            // Listeners
            list.querySelectorAll('.delete-record-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const food = parseFloat(e.currentTarget.getAttribute('data-food'));
                    deleteDailyRecord(id, food);
                });
            });
        }
        
        // Renderizar Compras
        function renderPurchases() {
            const list = document.getElementById('food-purchases-list');
            list.innerHTML = '';
            
            if (allPurchases.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-sm">No hay compras registradas.</p>`;
                return;
            }

            allPurchases.sort((a, b) => b.date.seconds - a.date.seconds);
            
            allPurchases.forEach(purchase => {
                const date = purchase.date.toDate();
                const item = `
                    <div class="p-3 bg-gray-50 rounded-md border">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-green-600">${date.toLocaleDateString()}</span>
                            <button class="delete-purchase-btn text-gray-400 hover:text-red-600" data-id="${purchase.id}" data-amount="${purchase.amountKg}">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-sm"><strong>Tipo:</strong> ${purchase.type}</p>
                        <p class="text-sm"><strong>Cantidad:</strong> ${purchase.amountKg} kg</p>
                        <p class="text-sm"><strong>Precio:</strong> $${purchase.price}</p>
                    </div>
                `;
                list.innerHTML += item;
            });
            
            feather.replace();
            
            // Listeners
            list.querySelectorAll('.delete-purchase-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const amount = parseFloat(e.currentTarget.getAttribute('data-amount'));
                    deletePurchase(id, amount);
                });
            });
        }
        
        // Renderizar Ventas
        function renderSales() {
            const list = document.getElementById('sales-list');
            list.innerHTML = '';
            
            if (allSales.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-sm">No hay ventas registradas.</p>`;
                return;
            }

            allSales.sort((a, b) => b.date.seconds - a.date.seconds);
            
            allSales.forEach(sale => {
                const date = sale.date.toDate();
                const item = `
                    <div class="p-3 bg-gray-50 rounded-md border">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-blue-600">${date.toLocaleDateString()}</span>
                            <button class="delete-sale-btn text-gray-400 hover:text-red-600" data-id="${sale.id}">
                                <i data-feather="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-sm"><strong>Cliente:</strong> ${sale.client}</p>
                        <p class="text-sm"><strong>Cantidad:</strong> ${sale.quantity} huevos</p>
                        <p class="text-sm"><strong>Precio:</strong> $${sale.price}</p>
                    </div>
                `;
                list.innerHTML += item;
            });
            
            feather.replace();
            
            // Listeners
            list.querySelectorAll('.delete-sale-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    deleteSale(id);
                });
            });
        }
        
        // Renderizar listas de Configuración (genérico)
        function renderConfigList(items, listId, deleteFn) {
            const list = document.getElementById(listId);
            const collectionName = listId.replace('config-', '').replace('-list', '');
            list.innerHTML = '';
            
            if (items.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-sm">No hay ítems cargados.</p>`;
                return;
            }
            
            items.sort((a, b) => a.name.localeCompare(b.name));
            
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'config-item';
                el.innerHTML = `
                    <span class="text-gray-700">${item.name}</span>
                    <button class="delete-config-btn text-gray-400 hover:text-red-600" data-id="${item.id}" data-collection="${collectionName}">
                        <i data-feather="x" class="w-4 h-4"></i>
                    </button>
                `;
                list.appendChild(el);
            });
            
            feather.replace();
            
            // Listeners
            list.querySelectorAll('.delete-config-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const col = e.currentTarget.getAttribute('data-collection');
                    
                    // Mapeo de nombre de colección
                    const colMap = {
                        'teacher': 'config_teachers',
                        'client': 'config_clients',
                        'activity': 'config_activities'
                    };
                    deleteFn(colMap[col], id);
                });
            });
        }
        
        // Actualizar Desplegable de Docentes
        function updateTeacherDropdowns() {
            const select = document.getElementById('record-responsible');
            select.innerHTML = '<option value="">Seleccione un docente</option>'; // Limpiar
            allTeachers.sort((a, b) => a.name.localeCompare(b.name));
            allTeachers.forEach(teacher => {
                select.innerHTML += `<option value="${teacher.name}">${teacher.name}</option>`;
            });
        }
        
        // Actualizar Desplegable de Clientes
        function updateClientDropdowns() {
            const select = document.getElementById('sale-client');
            select.innerHTML = '<option value="">Seleccione un cliente</option>'; // Limpiar
            allClients.sort((a, b) => a.name.localeCompare(b.name));
            allClients.forEach(client => {
                select.innerHTML += `<option value="${client.name}">${client.name}</option>`;
            });
        }
        
        // Actualizar Checkboxes de Actividades
        function updateActivityCheckboxes() {
            const container = document.getElementById('record-activities-checkboxes');
            container.innerHTML = ''; // Limpiar
            
            if (allActivities.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">Cargue actividades en Configuración.</p>`;
                return;
            }
            
            allActivities.sort((a, b) => a.name.localeCompare(b.name));
            allActivities.forEach(activity => {
                container.innerHTML += `
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" value="${activity.name}" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        ${activity.name}
                    </label>
                `;
            });
        }


        // --- 7. LÓGICA DEL DASHBOARD (Cálculos) ---

        // Función central para actualizar todas las métricas
        async function updateDashboard() {
            if (!userId) return; // Salir si no estamos listos
            
            const totalHens = allHenLots.reduce((sum, lot) => sum + lot.henCount, 0);
            const totalAnimals = allHenLots.reduce((sum, lot) => sum + lot.henCount + lot.roosterCount, 0);
            const totalDailyRation = allHenLots.reduce((sum, lot) => sum + ((lot.henCount + lot.roosterCount) * lot.rationPerAnimalKg), 0);
            
            // Obtener stock desde Firebase (es la fuente de verdad)
            const foodStock = await getInventoryStock(); 
            
            const foodDaysLeft = (totalDailyRation > 0 && foodStock > 0) ? (foodStock / totalDailyRation).toFixed(0) : 0;
            
            // Cálculos del Mes Actual
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            const filterByCurrentMonth = (item) => {
                const itemDate = item.date.toDate();
                return itemDate.getFullYear() === currentYear && itemDate.getMonth() === currentMonth;
            };

            const eggsThisMonth = allDailyRecords
                .filter(filterByCurrentMonth)
                .reduce((sum, r) => sum + r.eggsHarvested, 0);
                
            const salesThisMonth = allSales
                .filter(filterByCurrentMonth)
                .reduce((sum, s) => sum + s.price, 0);

            const purchasesThisMonth = allPurchases
                .filter(filterByCurrentMonth)
                .reduce((sum, p) => sum + p.price, 0);

            // Balance
            const balanceMonth = salesThisMonth - purchasesThisMonth;
            
            const { totalHarvested, totalSold } = calculateEggTotals();
            const eggStock = totalHarvested - totalSold;
            
            const totalIncome = allSales.reduce((sum, s) => sum + s.price, 0);
            const totalExpenses = allPurchases.reduce((sum, p) => sum + p.price, 0);
            const balanceTotal = totalIncome - totalExpenses;

            // Actualizar DOM
            document.getElementById('metric-total-hens').textContent = totalHens;
            document.getElementById('metric-food-stock').textContent = `${foodStock.toFixed(2)} kg`;
            document.getElementById('metric-food-days-left').textContent = `${foodDaysLeft} días`;
            
            // MODIFICADO: Mostrar métricas mensuales
            document.getElementById('metric-eggs-today').textContent = eggsThisMonth;
            document.getElementById('metric-sales-today').textContent = `$${salesThisMonth.toFixed(2)}`;
            document.getElementById('metric-egg-stock').textContent = eggStock;
            
            // MODIFICADO: Mostrar balance mensual
            document.getElementById('metric-balance-month').textContent = `$${balanceMonth.toFixed(2)}`;
            document.getElementById('metric-balance-month-detail').textContent = `(Ingresos: $${salesThisMonth.toFixed(2)} - Gastos: $${purchasesThisMonth.toFixed(2)})`;

            document.getElementById('metric-balance-total').textContent = `$${balanceTotal.toFixed(2)}`;
            document.getElementById('metric-balance-detail').textContent = `(Ingresos: $${totalIncome.toFixed(2)} - Gastos: $${totalExpenses.toFixed(2)})`;
        }
        
        // Calcular totales de huevos (para stock)
        function calculateEggTotals() {
            const totalHarvested = allDailyRecords.reduce((sum, r) => sum + r.eggsHarvested, 0);
            const totalSold = allSales.reduce((sum, s) => sum + s.quantity, 0);
            return { totalHarvested, totalSold };
        }
        
        // Actualizar Gráficos
        function updateCharts() {
            updateEggProductionChart();
            updateSalesByClientChart();
        }

        // Gráfico de Producción (por Mes)
        function updateEggProductionChart() {
            const ctx = document.getElementById('eggProductionChart');
            if (!ctx) return;
            
            // Agrupar huevos por mes (YYYY-MM)
            const eggsByMonth = allDailyRecords.reduce((acc, record) => {
                const date = record.date.toDate();
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!acc[monthKey]) {
                    acc[monthKey] = 0;
                }
                acc[monthKey] += record.eggsHarvested;
                return acc;
            }, {});
            
            const sortedLabels = Object.keys(eggsByMonth).sort();
            const data = sortedLabels.map(label => eggsByMonth[label]);

            if (eggChart) {
                eggChart.data.labels = sortedLabels;
                eggChart.data.datasets[0].data = data;
                eggChart.update();
            } else {
                eggChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedLabels,
                        datasets: [{
                            label: 'Huevos Cosechados por Mes',
                            data: data,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }
        
        // Gráfico de Ventas por Cliente
        function updateSalesByClientChart() {
            const ctx = document.getElementById('salesByClientChart');
            if (!ctx) return;
            
            // Agrupar ventas (total $) por cliente
            const salesByClient = allSales.reduce((acc, sale) => {
                const client = sale.client || 'Cliente Desconocido';
                if (!acc[client]) {
                    acc[client] = 0;
                }
                acc[client] += sale.price;
                return acc;
            }, {});
            
            const labels = Object.keys(salesByClient);
            const data = Object.values(salesByClient);

            if (salesChart) {
                salesChart.data.labels = labels;
                salesChart.data.datasets[0].data = data;
                salesChart.update();
            } else {
                salesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Vendido ($)',
                            data: data,
                            backgroundColor: [
                                'rgba(79, 70, 229, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)'
                            ],
                        }]
                    },
                    options: {
                        responsive: true
                    }
                });
            }
        }
        

        // --- 8. LÓGICA DE REPORTES (CSV) ---
        
        // Generar Reporte Unificado
        function generateUnifiedReport() {
            const year = parseInt(reportYearSelect.value);
            const month = parseInt(reportMonthSelect.value);
            const period = reportPeriodSelect.value;
            
            let data = [];
            let filename = `Reporte_Avicola_${year}`;
            
            // Filtros de fecha
            const filterFn = (item) => {
                const itemDate = item.date.toDate();
                if (period === 'annual') {
                    return itemDate.getFullYear() === year;
                } else {
                    return itemDate.getFullYear() === year && itemDate.getMonth() === month;
                }
            };

            if (period === 'monthly') {
                filename += `_${String(month + 1).padStart(2, '0')}`;
            }
            
            // Encabezados
            data.push([
                "Fecha", "Tipo de Movimiento", "Detalle", 
                "Actividades", "Observaciones", "Responsable/Cliente",
                "Cantidad (kg/huevos)", "Ingreso ($)", "Gasto ($)"
            ]);

            // Procesar Registros Diarios
            allDailyRecords.filter(filterFn).forEach(r => {
                data.push([
                    r.date.toDate().toLocaleDateString(),
                    "Registro Diario",
                    `Cosecha: ${r.eggsHarvested} huevos, Alimento: ${r.foodSuppliedKg} kg`,
                    r.activities ? r.activities.join(', ') : '', // NUEVO
                    r.observations || '', // NUEVO
                    r.responsible,
                    r.eggsHarvested, // Cantidad (huevos)
                    0, // Ingreso
                    0  // Gasto (el alimento se cuenta en Compras)
                ]);
            });

            // Procesar Compras
            allPurchases.filter(filterFn).forEach(p => {
                data.push([
                    p.date.toDate().toLocaleDateString(),
                    "Compra de Insumo",
                    p.type,
                    "", "", // Actividades, Obs
                    "Proveedor",
                    p.amountKg, // Cantidad (kg)
                    0, // Ingreso
                    p.price // Gasto
                ]);
            });

            // Procesar Ventas
            allSales.filter(filterFn).forEach(s => {
                data.push([
                    s.date.toDate().toLocaleDateString(),
                    "Venta de Huevos",
                    `${s.quantity} huevos`,
                    "", "", // Actividades, Obs
                    s.client,
                    s.quantity, // Cantidad (huevos)
                    s.price, // Ingreso
                    0 // Gasto
                ]);
            });

            // Ordenar por fecha
            data = [data[0], ...data.slice(1).sort((a, b) => new Date(a[0]) - new Date(b[0]))];

            downloadCSV(data, `${filename}.csv`);
        }
        
        // Función para descargar el CSV
        function downloadCSV(data, filename) {
            let csvContent = "data:text/csv;charset=utf-f8,";
            
            data.forEach(rowArray => {
                // Escapar comas y comillas
                let row = rowArray.map(item => {
                    let str = String(item);
                    if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                }).join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Reporte descargado.');
        }


        // --- 9. INICIAR LA APLICACIÓN ---
        initializeAppAndAuth();

    </script>
    
</body>
</html>